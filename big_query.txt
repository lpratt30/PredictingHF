STEPS: 

https://console.cloud.google.com/bigquery?sq=321960627270:6d20a7239605471ea244bb780b5fc1de
https://console.cloud.google.com/bigquery?sq=321960627270:eb7ec8ffcdf94080ae6c44c45c3b7516
https://console.cloud.google.com/bigquery?sq=321960627270:2141d09d66af47dfaacdcba7445662f9
https://console.cloud.google.com/bigquery?sq=321960627270:07a209217ac248cc9bc6867144a421ce
https://console.cloud.google.com/bigquery?sq=321960627270:f4a4bb65d4a84daa83800890d66d7cc1
https://console.cloud.google.com/bigquery?sq=321960627270:4a9be813e5304519aac6ab8073c48bcd

1: Create new project BD4H with Dataset named 'results'
-- Option to create new Dataset will populate once trying to save a bigquery table

2: Create query in diagnoses_icd (in physionet stared project) 

-- GET ANY HEART FAILURE ADMISSIONS 

SELECT
  admissions.HADM_ID,
  diagnoses.SUBJECT_ID,
  admissions.ADMITTIME
FROM `physionet-data.mimiciii_clinical.admissions` admissions
JOIN (
  SELECT DISTINCT 
    HADM_ID,
    SUBJECT_ID
  FROM 
    `physionet-data.mimiciii_clinical.diagnoses_icd`
  WHERE 
    REPLACE(ICD9_CODE, '.', '') IN (
      '39891', '40201', '40211', '40291',
      '40401', '40403', '40411', '40413', '40491', '40493', '4280', '4281',
      '42820', '42821', '42822', '42823', '42830', '42831', '42832', '42833',
      '42840', '42841', '42842', '42843', '4289'
    )
) diagnoses ON admissions.HADM_ID = diagnoses.HADM_ID
ORDER BY admissions.SUBJECT_ID
LIMIT 20000;

-- Get up to 20,000 unique heart failure hospital admission entries
-- Join it with admissions to get the time of admission 
-- It will not care if decimals are present 
-- Results in 14,040 items 

3: Save as bigquery table in BD4H project, named 'hf_admissions'

4: Create query in noteevents(in physionet stared project)

-- GET ANY HEART FAILURE ADMISSIONS WITH NOTES

WITH longest_notes AS (
  SELECT
    noteevents.HADM_ID,
    noteevents.SUBJECT_ID,
    noteevents.TEXT,
    unique_hf.ADMITTIME,
    ROW_NUMBER() OVER (
      PARTITION BY noteevents.HADM_ID
      ORDER BY LENGTH(noteevents.TEXT) DESC
    ) AS rownumber
  FROM `physionet-data.mimiciii_notes.noteevents` noteevents
  INNER JOIN `bd4h-404014.results.hf_admissions` unique_hf
    ON noteevents.HADM_ID = unique_hf.HADM_ID
  WHERE noteevents.CATEGORY = 'Discharge summary'
    AND noteevents.TEXT IS NOT NULL AND noteevents.TEXT != ''
    AND noteevents.ISERROR IS DISTINCT FROM 1 -- Not stated in the paper, doesnt seem to change results
)
SELECT
  HADM_ID,
  SUBJECT_ID,
  TEXT,
  ADMITTIME
FROM longest_notes
WHERE rownumber = 1
LIMIT 200000;


5: Save as bigquery table in BD4H project, named 'hf_admissions_notes'

6: Run each of the following queries to get the respective datasets 

-- GET READMISSIONS

SELECT
  HADM_ID,
  SUBJECT_ID,
  ADMITTIME
FROM (
  SELECT
    HADM_ID,
    SUBJECT_ID,
    ADMITTIME,
    LEAD(ADMITTIME) OVER (PARTITION BY SUBJECT_ID ORDER BY ADMITTIME) as NextAdmitTime
  FROM `bd4h-404014.results.hf_admissions`
) as Admissions
WHERE NextAdmitTime IS NOT NULL
ORDER BY SUBJECT_ID;


-- GET READMISSIONS WITH NOTES

SELECT
  Admissions.HADM_ID,
  Admissions.SUBJECT_ID,
  Admissions.ADMITTIME
FROM (
  SELECT
    admissions.HADM_ID,
    admissions.SUBJECT_ID,
    admissions.ADMITTIME,
    LEAD(admissions.ADMITTIME) OVER (PARTITION BY admissions.SUBJECT_ID ORDER BY admissions.ADMITTIME) as NextAdmitTime
  FROM `bd4h-404014.results.hf_admissions` admissions
  INNER JOIN `bd4h-404014.results.hf_admissions_notes` notes
    ON admissions.HADM_ID = notes.HADM_ID
) as Admissions
WHERE Admissions.NextAdmitTime IS NOT NULL;


-- GET 30DAY READMISSIONS 

SELECT
  HADM_ID,
  SUBJECT_ID,
  ADMITTIME,
  NextAdmitTime
FROM (
  SELECT
    HADM_ID,
    SUBJECT_ID,
    ADMITTIME,
    LEAD(ADMITTIME) OVER (PARTITION BY SUBJECT_ID ORDER BY ADMITTIME) as NextAdmitTime
  FROM `bd4h-404014.results.hf_admissions`
) as AdmissionsWithNext
WHERE NextAdmitTime IS NOT NULL
AND TIMESTAMP_DIFF(NextAdmitTime, ADMITTIME, DAY) < 31
ORDER BY SUBJECT_ID, ADMITTIME;


-- https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_diff 
-- https://cloud.google.com/bigquery/docs/reference/standard-sql/timestamp_functions#timestamp_diff


-- GET 30DAY READMISSIONS WITH NOTES 

SELECT
  AdmissionsWithNext.HADM_ID,
  AdmissionsWithNext.SUBJECT_ID,
  AdmissionsWithNext.ADMITTIME,
  AdmissionsWithNext.NextAdmitTime
FROM (
  SELECT
    HADM_ID,
    SUBJECT_ID,
    ADMITTIME,
    LEAD(ADMITTIME) OVER (PARTITION BY SUBJECT_ID ORDER BY ADMITTIME) as NextAdmitTime
  FROM `bd4h-404014.results.hf_admissions`
) as AdmissionsWithNext
INNER JOIN `bd4h-404014.results.hf_admissions_notes` notes
ON AdmissionsWithNext.HADM_ID = notes.HADM_ID
WHERE AdmissionsWithNext.NextAdmitTime IS NOT NULL
AND TIMESTAMP_DIFF(AdmissionsWithNext.NextAdmitTime, AdmissionsWithNext.ADMITTIME, DAY) < 31
ORDER BY AdmissionsWithNext.SUBJECT_ID, AdmissionsWithNext.ADMITTIME;



-- https://cloud.google.com/bigquery/docs/reference/standard-sql/date_functions#date_diff 
-- https://cloud.google.com/bigquery/docs/reference/standard-sql/timestamp_functions#timestamp_diff

